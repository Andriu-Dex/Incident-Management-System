@using IncidentsTI.Application.Commands
@using IncidentsTI.Application.DTOs.Notifications
@using IncidentsTI.Application.Queries
@using MediatR
@using Microsoft.AspNetCore.Components.Authorization
@rendermode InteractiveServer
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="relative">
    <!-- Notification Bell Button -->
    <button @onclick="ToggleDropdown" 
            @onclick:stopPropagation="true"
            class="relative p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        @if (unreadCount > 0)
        {
            <span class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-red-500 rounded-full min-w-[20px]">
                @(unreadCount > 99 ? "99+" : unreadCount.ToString())
            </span>
        }
    </button>

    <!-- Dropdown Panel -->
    @if (isOpen)
    {
        <!-- Backdrop para cerrar al hacer clic fuera -->
        <div class="fixed inset-0 z-40" @onclick="CloseDropdown"></div>
        
        <div class="absolute right-0 mt-2 w-96 bg-white rounded-xl shadow-2xl border border-gray-200 z-50 overflow-hidden">
            <!-- Header -->
            <div class="px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    Notificaciones
                </h3>
                @if (unreadCount > 0)
                {
                    <button @onclick="MarkAllAsRead" 
                            @onclick:stopPropagation="true"
                            class="text-sm text-blue-100 hover:text-white flex items-center gap-1 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Marcar todas
                    </button>
                }
            </div>

            <!-- Notification List -->
            <div class="max-h-[400px] overflow-y-auto">
                @if (isLoading)
                {
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                }
                else if (!notifications.Any())
                {
                    <div class="py-12 text-center">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <p class="text-gray-500 font-medium">No hay notificaciones</p>
                        <p class="text-gray-400 text-sm mt-1">Te notificaremos cuando haya novedades</p>
                    </div>
                }
                else
                {
                    <div class="divide-y divide-gray-100">
                        @foreach (var notification in notifications)
                        {
                            <div @onclick="() => HandleNotificationClick(notification)" 
                                 @onclick:stopPropagation="true"
                                 class="@(notification.IsRead ? "bg-white" : "bg-blue-50") hover:bg-gray-50 p-4 cursor-pointer transition-colors">
                                <div class="flex items-start gap-3">
                                    <!-- Icon -->
                                    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center @GetIconBgClass(notification.TypeClass)">
                                        <i class="bi @notification.TypeIcon @GetIconTextClass(notification.TypeClass)"></i>
                                    </div>
                                    <!-- Content -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between gap-2">
                                            <p class="text-sm font-semibold text-gray-900 truncate">@notification.Title</p>
                                            @if (!notification.IsRead)
                                            {
                                                <span class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full"></span>
                                            }
                                        </div>
                                        <p class="text-sm text-gray-600 line-clamp-2 mt-0.5">@notification.Message</p>
                                        <p class="text-xs text-gray-400 mt-1">@notification.TimeAgo</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Footer -->
            @if (notifications.Any())
            {
                <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
                    <a href="/notifications" @onclick="CloseDropdown" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center gap-1">
                        Ver todas las notificaciones
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool isOpen = false;
    private bool isLoading = false;
    private int unreadCount = 0;
    private List<NotificationDto> notifications = new();
    private string? currentUserId;
    private System.Timers.Timer? refreshTimer;
    private DotNetObjectReference<NotificationBell>? dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        if (!string.IsNullOrEmpty(currentUserId))
        {
            await LoadUnreadCount();
            StartAutoRefresh();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(currentUserId))
        {
            dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("registerSignalRCallback", dotNetRef, "notification-count-updated", "OnNotificationCountUpdated");
        }
    }

    [JSInvokable]
    public async Task OnNotificationCountUpdated(object data)
    {
        await LoadUnreadCount();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadCurrentUser()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        }
    }

    private void StartAutoRefresh()
    {
        refreshTimer = new System.Timers.Timer(30000); // 30 segundos
        refreshTimer.Elapsed += async (sender, e) =>
        {
            await InvokeAsync(async () =>
            {
                await LoadUnreadCount();
                StateHasChanged();
            });
        };
        refreshTimer.Start();
    }

    private async Task LoadUnreadCount()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        try
        {
            unreadCount = await Mediator.Send(new GetUnreadNotificationCountQuery(currentUserId));
        }
        catch
        {
            unreadCount = 0;
        }
    }

    private async Task LoadNotifications()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        isLoading = true;
        StateHasChanged();
        
        try
        {
            notifications = await Mediator.Send(new GetUserNotificationsQuery(currentUserId, 10));
            unreadCount = notifications.Count(n => !n.IsRead);
        }
        catch
        {
            notifications = new List<NotificationDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ToggleDropdown()
    {
        isOpen = !isOpen;
        if (isOpen)
        {
            await LoadNotifications();
        }
    }

    private void CloseDropdown()
    {
        isOpen = false;
    }

    private async Task HandleNotificationClick(NotificationDto notification)
    {
        if (!notification.IsRead)
        {
            await Mediator.Send(new MarkNotificationAsReadCommand(notification.Id));
            notification.IsRead = true;
            unreadCount = Math.Max(0, unreadCount - 1);
        }

        CloseDropdown();

        if (!string.IsNullOrEmpty(notification.ActionUrl))
        {
            Navigation.NavigateTo(notification.ActionUrl);
        }
    }

    private async Task MarkAllAsRead()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        await Mediator.Send(new MarkAllNotificationsAsReadCommand(currentUserId));
        
        foreach (var notification in notifications)
        {
            notification.IsRead = true;
        }
        unreadCount = 0;
    }

    private string GetIconBgClass(string typeClass) => typeClass switch
    {
        "text-primary" => "bg-blue-100",
        "text-info" => "bg-cyan-100",
        "text-success" => "bg-green-100",
        "text-warning" => "bg-yellow-100",
        "text-danger" => "bg-red-100",
        "text-secondary" => "bg-gray-100",
        "text-purple" => "bg-purple-100",
        "text-dark" => "bg-slate-100",
        _ => "bg-gray-100"
    };

    private string GetIconTextClass(string typeClass) => typeClass switch
    {
        "text-primary" => "text-blue-600",
        "text-info" => "text-cyan-600",
        "text-success" => "text-green-600",
        "text-warning" => "text-yellow-600",
        "text-danger" => "text-red-600",
        "text-secondary" => "text-gray-600",
        "text-purple" => "text-purple-600",
        "text-dark" => "text-slate-600",
        _ => "text-gray-600"
    };

    public void Dispose()
    {
        refreshTimer?.Stop();
        refreshTimer?.Dispose();
        
        if (dotNetRef != null)
        {
            try
            {
                _ = JSRuntime.InvokeVoidAsync("unregisterSignalRCallback", dotNetRef, "notification-count-updated");
            }
            catch { }
            dotNetRef.Dispose();
        }
    }
}
