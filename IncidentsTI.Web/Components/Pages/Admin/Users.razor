@page "/admin/users"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Administrator")]
@using IncidentsTI.Application.DTOs.Users
@using IncidentsTI.Application.Features.Users.Commands
@using IncidentsTI.Application.Features.Users.Queries
@using MediatR
@inject IMediator Mediator
@inject IToastService ToastService

<PageTitle>Gestión de Usuarios</PageTitle>

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Gestión de Usuarios</h1>
        <button type="button" @onclick="OpenCreateUserModal" class="btn btn-primary">
            <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Nuevo Usuario
        </button>
    </div>

    <!-- Filtros -->
    <div class="bg-white rounded-xl p-6 shadow-md border border-gray-200 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Buscar por nombre</label>
                <input type="text" @bind="searchName" @bind:event="oninput" @bind:after="ApplyFilters" 
                       placeholder="Nombre o apellido..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Buscar por email</label>
                <input type="text" @bind="searchEmail" @bind:event="oninput" @bind:after="ApplyFilters" 
                       placeholder="Correo electrónico..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Rol</label>
                <select @bind="roleFilter" @bind:after="ApplyFilters" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Todos los roles</option>
                    <option value="Student">Estudiante</option>
                    <option value="Teacher">Docente</option>
                    <option value="Administrative">Administrativo</option>
                    <option value="Technician">Técnico</option>
                    <option value="Administrator">Administrador</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Estado</label>
                <select @bind="statusFilter" @bind:after="ApplyFilters" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Todos</option>
                    <option value="active">Activos</option>
                    <option value="inactive">Inactivos</option>
                </select>
            </div>
            <div class="flex items-end">
                <button @onclick="ClearFilters" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all duration-200 font-semibold flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Limpiar
                </button>
            </div>
        </div>
        <div class="mt-4 text-sm text-gray-600">
            Mostrando @filteredUsers.Count() de @users.Count() usuarios
        </div>
    </div>

    @if (isLoading)
    {
        <div class="flex justify-center items-center py-12">
            <svg class="animate-spin h-12 w-12 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    }
    else if (users == null || !users.Any())
    {
        <div class="card text-center py-12">
            <p class="text-gray-500 text-lg">No hay usuarios registrados</p>
        </div>
    }
    else if (!pagedUsers.Any())
    {
        <div class="card text-center py-12">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <p class="text-gray-500 text-lg">No se encontraron usuarios con los filtros aplicados</p>
        </div>
    }
    else
    {
        <div class="card overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Usuario
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Email
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Roles
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Estado
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Acciones
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var user in pagedUsers)
                    {
                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <div class="h-10 w-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold">
                                            @GetInitials(user.FirstName, user.LastName)
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            @user.FirstName @user.LastName
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">@user.Email</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex flex-wrap gap-2">
                                    @foreach (var role in user.Roles)
                                    {
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                            @GetRoleDisplayName(role)
                                        </span>
                                    }
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                @if (user.IsActive)
                                {
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                        Activo
                                    </span>
                                }
                                else
                                {
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                        Inactivo
                                    </span>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button @onclick="() => ToggleUserStatus(user.Id)" 
                                        class="@(user.IsActive ? "text-yellow-600 hover:text-yellow-700" : "text-green-600 hover:text-green-700") mr-3">
                                    @(user.IsActive ? "Desactivar" : "Activar")
                                </button>
                                <button @onclick="() => ConfirmDeleteUser(user)" 
                                        class="text-red-600 hover:text-red-700">
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        @if (totalPages > 1)
        {
            <div class="flex justify-center items-center mt-6 gap-2">
                <button @onclick="GoToFirstPage" disabled="@(currentPage == 1)"
                        class="px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                    </svg>
                </button>
                <button @onclick="GoToPreviousPage" disabled="@(currentPage == 1)"
                        class="px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                
                @foreach (var pageNum in GetPageNumbers())
                {
                    <button @onclick="() => GoToPage(pageNum)" 
                            class="@(pageNum == currentPage ? "px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold" : "px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50") transition-all duration-200">
                        @pageNum
                    </button>
                }
                
                <button @onclick="GoToNextPage" disabled="@(currentPage == totalPages)"
                        class="px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <button @onclick="GoToLastPage" disabled="@(currentPage == totalPages)"
                        class="px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                    </svg>
                </button>
                
                <span class="ml-4 text-sm text-gray-600">
                    Página @currentPage de @totalPages
                </span>
            </div>
        }
    }
</div>

@if (showModal)
{
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999;" @onclick="CloseModal">
        <div style="position: relative; top: 100px; max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" @onclick:stopPropagation="true">
            <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                <h3 style="font-size: 1.25rem; font-weight: 600;">Crear Nuevo Usuario</h3>
                <button type="button" @onclick="CloseModal" style="color: #9ca3af; cursor: pointer; background: none; border: none; font-size: 24px; padding: 0; width: 32px; height: 32px;">
                    ×
                </button>
            </div>
            <CreateUserModal OnUserCreated="HandleUserCreated" OnCancel="CloseModal" />
        </div>
    </div>
}

@if (showDeleteModal && userToDelete != null)
{
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999;" @onclick="CloseDeleteModal">
        <div style="position: relative; top: 150px; max-width: 450px; margin: 0 auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" @onclick:stopPropagation="true">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-red-100 mb-4">
                    <svg class="h-7 w-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Eliminar Usuario</h3>
                <p class="text-gray-600 mb-6">
                    ¿Estás seguro de que deseas eliminar al usuario <strong>@userToDelete.FirstName @userToDelete.LastName</strong>? Esta acción no se puede deshacer.
                </p>
                <div class="flex justify-center gap-3">
                    <button @onclick="CloseDeleteModal" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold transition-all duration-200">
                        Cancelar
                    </button>
                    <button @onclick="DeleteUser" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition-all duration-200">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<UserDto> users = new();
    private List<UserDto> filteredUsers = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool showDeleteModal = false;
    private UserDto? userToDelete;
    
    // Filtros
    private string searchName = "";
    private string searchEmail = "";
    private string roleFilter = "";
    private string statusFilter = "";
    
    // Paginación
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling((double)filteredUsers.Count / pageSize);
    private IEnumerable<UserDto> pagedUsers => filteredUsers.Skip((currentPage - 1) * pageSize).Take(pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        try
        {
            var query = new GetAllUsersQuery();
            users = await Mediator.Send(query);
            ApplyFilters();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error al cargar usuarios: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        filteredUsers = users;

        // Filtro por nombre
        if (!string.IsNullOrWhiteSpace(searchName))
        {
            var searchTerm = searchName.ToLower();
            filteredUsers = filteredUsers.Where(u => 
                u.FirstName.ToLower().Contains(searchTerm) || 
                u.LastName.ToLower().Contains(searchTerm) ||
                $"{u.FirstName} {u.LastName}".ToLower().Contains(searchTerm)
            ).ToList();
        }

        // Filtro por email
        if (!string.IsNullOrWhiteSpace(searchEmail))
        {
            var searchTerm = searchEmail.ToLower();
            filteredUsers = filteredUsers.Where(u => 
                u.Email.ToLower().Contains(searchTerm)
            ).ToList();
        }

        // Filtro por rol
        if (!string.IsNullOrEmpty(roleFilter))
        {
            filteredUsers = filteredUsers.Where(u => u.Roles.Contains(roleFilter)).ToList();
        }

        // Filtro por estado
        if (statusFilter == "active")
        {
            filteredUsers = filteredUsers.Where(u => u.IsActive).ToList();
        }
        else if (statusFilter == "inactive")
        {
            filteredUsers = filteredUsers.Where(u => !u.IsActive).ToList();
        }

        // Resetear a página 1 cuando se aplican filtros
        currentPage = 1;
    }

    private void ClearFilters()
    {
        searchName = "";
        searchEmail = "";
        roleFilter = "";
        statusFilter = "";
        filteredUsers = users;
        currentPage = 1;
    }

    // Métodos de paginación
    private void GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
        }
    }

    private void GoToFirstPage() => GoToPage(1);
    private void GoToPreviousPage() => GoToPage(currentPage - 1);
    private void GoToNextPage() => GoToPage(currentPage + 1);
    private void GoToLastPage() => GoToPage(totalPages);

    private IEnumerable<int> GetPageNumbers()
    {
        int startPage = Math.Max(1, currentPage - 2);
        int endPage = Math.Min(totalPages, currentPage + 2);

        // Ajustar para mostrar siempre 5 páginas si es posible
        if (endPage - startPage < 4)
        {
            if (startPage == 1)
            {
                endPage = Math.Min(5, totalPages);
            }
            else if (endPage == totalPages)
            {
                startPage = Math.Max(1, totalPages - 4);
            }
        }

        return Enumerable.Range(startPage, endPage - startPage + 1);
    }

    private async Task ToggleUserStatus(string userId)
    {
        try
        {
            var command = new ToggleUserStatusCommand { UserId = userId };
            var result = await Mediator.Send(command);

            if (result)
            {
                ToastService.ShowSuccess("Estado del usuario actualizado");
                await LoadUsers();
            }
            else
            {
                ToastService.ShowError("No se pudo actualizar el estado del usuario");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }
    }

    private void OpenCreateUserModal()
    {
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task HandleUserCreated()
    {
        showModal = false;
        await LoadUsers();
    }

    private void ConfirmDeleteUser(UserDto user)
    {
        userToDelete = user;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        userToDelete = null;
    }

    private async Task DeleteUser()
    {
        if (userToDelete == null) return;

        try
        {
            var command = new DeleteUserCommand { UserId = userToDelete.Id };
            var result = await Mediator.Send(command);

            if (result)
            {
                ToastService.ShowSuccess($"Usuario {userToDelete.FirstName} {userToDelete.LastName} eliminado");
                CloseDeleteModal();
                await LoadUsers();
            }
            else
            {
                ToastService.ShowError("No se pudo eliminar el usuario");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }
    }

    private string GetInitials(string firstName, string lastName)
    {
        var first = !string.IsNullOrEmpty(firstName) ? firstName[0].ToString().ToUpper() : "";
        var last = !string.IsNullOrEmpty(lastName) ? lastName[0].ToString().ToUpper() : "";
        return first + last;
    }

    private string GetRoleDisplayName(string role)
    {
        return role switch
        {
            "Student" => "Estudiante",
            "Teacher" => "Docente",
            "Administrative" => "Administrativo",
            "Technician" => "Técnico",
            "Administrator" => "Administrador",
            _ => role
        };
    }
}
