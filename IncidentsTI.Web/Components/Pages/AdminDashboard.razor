@* AdminDashboard.razor - Dashboard de Administrador Rediseñado *@
@* Basado en ISO 9241-110 (Usabilidad), DCU (Diseño Centrado en Usuario) y WCAG 2.1 (Accesibilidad) *@

@page "/admin/dashboard"
@attribute [Authorize(Roles = "Administrator")]

@using IncidentsTI.Application.DTOs.Statistics
@using IncidentsTI.Application.Queries
@using IncidentsTI.Application.Reports.DTOs
@using MediatR
@inject IMediator Mediator
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<PageTitle>Panel de Control - Administración</PageTitle>

@* Skip Link para accesibilidad - WCAG 2.4.1 *@
<a href="#main-content" 
   class="sr-only focus:not-sr-only focus:absolute focus:z-50 focus:p-4 
          focus:bg-blue-600 focus:text-white focus:rounded-lg focus:m-2">
    Saltar al contenido principal
</a>

<main id="main-content" class="bg-gradient-to-br from-slate-50 via-gray-50 to-slate-100 pb-8">
    @* Header del Dashboard - Integrado sin sticky para evitar doble barra *@
    <div class="bg-white/80 backdrop-blur-sm border-b border-gray-200">
        <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div class="flex items-center gap-4">
                    @* Icono y título *@
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 
                                flex items-center justify-center shadow-lg shadow-blue-500/25">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">
                            Panel de Control
                        </h1>
                        <p class="text-sm text-gray-500 mt-0.5">
                            Monitoreo y análisis de incidentes en tiempo real
                        </p>
                    </div>
                </div>
                
                @* Última actualización *@
                <div class="flex items-center gap-3 text-sm text-gray-500">
                    <div class="flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 rounded-lg">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        <span>En vivo</span>
                    </div>
                    <span>Última actualización: @lastUpdated.ToString("HH:mm:ss")</span>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-8 space-y-6">
        
        @* Panel de Filtros *@
        <FilterPanel StartDate="@startDate" 
                     EndDate="@endDate" 
                     SelectedPeriod="@selectedPeriod"
                     ShowExportButton="true"
                     OnFilterApply="HandleFilterApply"
                     OnExport="HandleExport" />

        @if (isLoading)
        {
            @* Estado de carga con skeleton accesible *@
            <div role="status" aria-live="polite" aria-label="Cargando estadísticas">
                <LoadingSkeleton />
            </div>
        }
        else if (statistics == null)
        {
            @* Estado de error *@
            <div class="bg-red-50 border border-red-200 rounded-2xl p-8 text-center" role="alert">
                <svg class="w-16 h-16 mx-auto text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <h2 class="text-xl font-semibold text-red-700 mb-2">Error al cargar estadísticas</h2>
                <p class="text-red-600 mb-4">No se pudieron obtener los datos del dashboard.</p>
                <button @onclick="LoadStatistics" 
                        class="px-6 py-2.5 bg-red-600 text-white rounded-xl hover:bg-red-700 
                               transition-colors focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    Reintentar
                </button>
            </div>
        }
        else
        {
            @* KPIs Principales - Grid responsivo con 4-7 columnas *@
            <section aria-labelledby="kpi-heading">
                <h2 id="kpi-heading" class="sr-only">Indicadores clave de rendimiento</h2>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-4">
                    <KpiCard Title="Total Incidentes"
                             Value="@statistics.TotalIncidents.ToString("N0")"
                             ColorScheme="slate"
                             DefaultIconPath="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    
                    <KpiCard Title="Abiertos"
                             Value="@statistics.OpenIncidents.ToString("N0")"
                             ColorScheme="blue"
                             DefaultIconPath="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    
                    <KpiCard Title="En Progreso"
                             Value="@statistics.InProgressIncidents.ToString("N0")"
                             ColorScheme="amber"
                             DefaultIconPath="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    
                    <KpiCard Title="Escalados"
                             Value="@statistics.EscalatedIncidents.ToString("N0")"
                             ColorScheme="orange"
                             DefaultIconPath="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    
                    <KpiCard Title="Resueltos"
                             Value="@statistics.ResolvedIncidents.ToString("N0")"
                             ColorScheme="emerald"
                             ProgressValue="@GetResolutionRateInt()"
                             ProgressLabel="Tasa de resolución"
                             DefaultIconPath="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    
                    <KpiCard Title="Cerrados"
                             Value="@statistics.ClosedIncidents.ToString("N0")"
                             ColorScheme="gray"
                             DefaultIconPath="M5 13l4 4L19 7" />
                    
                    <KpiCard Title="Sin Asignar"
                             Value="@statistics.UnassignedIncidents.ToString("N0")"
                             ColorScheme="red"
                             TrendValue="@(statistics.UnassignedIncidents > 5 ? 15 : -10)"
                             TrendIsPositive="false"
                             DefaultIconPath="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" />
                </div>
            </section>

            @* Métricas de Tiempo *@
            <section aria-labelledby="time-metrics-heading" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <h2 id="time-metrics-heading" class="sr-only">Métricas de tiempo</h2>
                
                <TimeMetricCard Title="Tiempo Promedio de Resolución"
                                FormattedValue="@FormatHours(statistics.AverageResolutionTimeHours)"
                                Unit="horas"
                                Description="Tiempo promedio desde apertura hasta resolución"
                                Badge="Objetivo: 24h"
                                Variant="blue"
                                CurrentValue="@statistics.AverageResolutionTimeHours"
                                TargetValue="24">
                    <IconContent>
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </IconContent>
                </TimeMetricCard>
                
                <TimeMetricCard Title="Tiempo de Primera Respuesta"
                                FormattedValue="@FormatHours(statistics.AverageFirstResponseTimeHours)"
                                Unit="horas"
                                Description="Tiempo promedio hasta la primera respuesta"
                                Badge="Objetivo: 4h"
                                Variant="green"
                                CurrentValue="@statistics.AverageFirstResponseTimeHours"
                                TargetValue="4">
                    <IconContent>
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </IconContent>
                </TimeMetricCard>
            </section>

            @* Gráficos - Primera fila *@
            <section aria-labelledby="charts-heading-1" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <h2 id="charts-heading-1" class="sr-only">Distribución de incidentes</h2>
                
                @* Gráfico de Estado *@
                <ChartCard Title="Por Estado" 
                           Subtitle="Distribución actual"
                           ColorScheme="blue"
                           IsLoading="@isLoadingCharts"
                           NoData="@(statistics.IncidentsByStatus?.Count == 0)">
                    <IconContent>
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                        </svg>
                    </IconContent>
                    <ChildContent>
                        <canvas id="statusChart" class="w-full h-full"></canvas>
                    </ChildContent>
                    <FooterContent>
                        <div class="flex flex-wrap gap-3 text-xs">
                            @foreach (var status in statistics.IncidentsByStatus ?? new List<StatusStatDto>())
                            {
                                <div class="flex items-center gap-1.5">
                                    <span class="w-2.5 h-2.5 rounded-full @GetStatusColorClass(status.Status)"></span>
                                    <span class="text-gray-600">@GetStatusDisplay(status.Status): @status.Count</span>
                                </div>
                            }
                        </div>
                    </FooterContent>
                </ChartCard>

                @* Gráfico de Prioridad *@
                <ChartCard Title="Por Prioridad" 
                           Subtitle="Distribución actual"
                           ColorScheme="amber"
                           IsLoading="@isLoadingCharts"
                           NoData="@(statistics.IncidentsByPriority?.Count == 0)">
                    <IconContent>
                        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                    </IconContent>
                    <ChildContent>
                        <canvas id="priorityChart" class="w-full h-full"></canvas>
                    </ChildContent>
                    <FooterContent>
                        <div class="flex flex-wrap gap-3 text-xs">
                            @foreach (var priority in statistics.IncidentsByPriority ?? new List<PriorityStatDto>())
                            {
                                <div class="flex items-center gap-1.5">
                                    <span class="w-2.5 h-2.5 rounded-full @GetPriorityColorClass(priority.Priority)"></span>
                                    <span class="text-gray-600">@GetPriorityDisplay(priority.Priority): @priority.Count</span>
                                </div>
                            }
                        </div>
                    </FooterContent>
                </ChartCard>

                @* Gráfico de Categoría/Tipo *@
                <ChartCard Title="Por Categoría" 
                           Subtitle="Tipos de incidentes"
                           ColorScheme="purple"
                           IsLoading="@isLoadingCharts"
                           NoData="@(statistics.IncidentsByType?.Count == 0)">
                    <IconContent>
                        <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                    </IconContent>
                    <ChildContent>
                        <canvas id="typeChart" class="w-full h-full"></canvas>
                    </ChildContent>
                </ChartCard>
            </section>

            @* Gráfico de Tendencia - Full width *@
            <section aria-labelledby="trend-heading">
                <h2 id="trend-heading" class="sr-only">Tendencia de incidentes</h2>
                
                <ChartCard Title="Tendencia de Incidentes" 
                           Subtitle="Evolución en el tiempo"
                           ColorScheme="indigo"
                           HeightClass="h-80"
                           IsLoading="@isLoadingCharts"
                           NoData="@(trendData?.Count == 0)">
                    <IconContent>
                        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                        </svg>
                    </IconContent>
                    <HeaderActions>
                        <div class="flex items-center gap-1 p-1 bg-gray-100 rounded-lg" role="tablist">
                            <button @onclick='() => SetTrendPeriod("daily")'
                                    class="@GetTrendButtonClass("daily")"
                                    role="tab"
                                    aria-selected="@(trendPeriod == "daily")">
                                Día
                            </button>
                            <button @onclick='() => SetTrendPeriod("weekly")'
                                    class="@GetTrendButtonClass("weekly")"
                                    role="tab"
                                    aria-selected="@(trendPeriod == "weekly")">
                                Semana
                            </button>
                            <button @onclick='() => SetTrendPeriod("monthly")'
                                    class="@GetTrendButtonClass("monthly")"
                                    role="tab"
                                    aria-selected="@(trendPeriod == "monthly")">
                                Mes
                            </button>
                        </div>
                    </HeaderActions>
                    <ChildContent>
                        <canvas id="trendChart" class="w-full h-full"></canvas>
                    </ChildContent>
                </ChartCard>
            </section>

            @* Top Servicios - Bar Chart *@
            <section aria-labelledby="services-chart-heading">
                <h2 id="services-chart-heading" class="sr-only">Servicios más afectados</h2>
                
                <ChartCard Title="Top 10 Servicios Afectados" 
                           Subtitle="Mayor volumen de incidentes"
                           ColorScheme="cyan"
                           HeightClass="h-72"
                           IsLoading="@isLoadingCharts"
                           NoData="@(statistics.IncidentsByService?.Count == 0)">
                    <IconContent>
                        <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                    </IconContent>
                    <ChildContent>
                        <canvas id="topServicesChart" class="w-full h-full"></canvas>
                    </ChildContent>
                </ChartCard>
            </section>

            @* Tablas de Datos *@
            <section aria-labelledby="tables-heading" class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                <h2 id="tables-heading" class="sr-only">Datos detallados</h2>
                
                @* Tabla de Servicios *@
                <StatTable TItem="ServiceStatDto"
                           Title="Detalle por Servicio"
                           Subtitle="Métricas de incidentes por servicio"
                           Items="@statistics.IncidentsByService"
                           MaxItems="8"
                           ColumnCount="4"
                           ColorScheme="cyan">
                    <IconContent>
                        <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                        </svg>
                    </IconContent>
                    <HeaderTemplate>
                        <th scope="col" class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Servicio
                        </th>
                        <th scope="col" class="px-5 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Incidentes
                        </th>
                        <th scope="col" class="px-5 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Abiertos
                        </th>
                        <th scope="col" class="px-5 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Tasa Resolución
                        </th>
                    </HeaderTemplate>
                    <RowTemplate Context="service">
                        <td class="px-5 py-3.5">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-cyan-50 flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                              d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2"/>
                                    </svg>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate" title="@service.ServiceName">
                                        @service.ServiceName
                                    </p>
                                    <p class="text-xs text-gray-500">@GetCategoryDisplay(service.Category)</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-5 py-3.5 text-center">
                            <span class="text-sm font-semibold text-gray-900">@service.TotalIncidents</span>
                        </td>
                        <td class="px-5 py-3.5 text-center">
                            <span class="px-2 py-1 text-xs font-medium @GetOpenCountClass(service.OpenIncidents) rounded-full">
                                @service.OpenIncidents
                            </span>
                        </td>
                        <td class="px-5 py-3.5 text-center">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-sm font-semibold @GetResolutionRateClass(GetServiceResolutionRate(service))">
                                    @GetServiceResolutionRate(service).ToString("F1")%
                                </span>
                                <div class="w-16 bg-gray-100 rounded-full h-1.5">
                                    <div class="h-full rounded-full @GetResolutionRateBarClass(GetServiceResolutionRate(service))"
                                         style="width: @GetServiceResolutionRate(service)%"></div>
                                </div>
                            </div>
                        </td>
                    </RowTemplate>
                </StatTable>

                @* Tabla de Técnicos *@
                <StatTable TItem="TechnicianStatDto"
                           Title="Rendimiento de Técnicos"
                           Subtitle="Métricas de desempeño individual"
                           Items="@statistics.IncidentsByTechnician"
                           MaxItems="8"
                           ColumnCount="5"
                           ColorScheme="violet">
                    <IconContent>
                        <svg class="w-5 h-5 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </IconContent>
                    <HeaderTemplate>
                        <th scope="col" class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Técnico
                        </th>
                        <th scope="col" class="px-5 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Asignados
                        </th>
                        <th scope="col" class="px-5 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Resueltos
                        </th>
                        <th scope="col" class="px-5 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Tiempo Prom.
                        </th>
                        <th scope="col" class="px-5 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Tasa
                        </th>
                    </HeaderTemplate>
                    <RowTemplate Context="tech">
                        <td class="px-5 py-3.5">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-violet-400 to-purple-500 
                                            flex items-center justify-center text-white text-sm font-medium shadow-sm">
                                    @GetInitials(tech.TechnicianName)
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate" title="@tech.TechnicianName">
                                        @tech.TechnicianName
                                    </p>
                                </div>
                            </div>
                        </td>
                        <td class="px-5 py-3.5 text-center">
                            <span class="text-sm font-semibold text-gray-900">@tech.TotalAssigned</span>
                        </td>
                        <td class="px-5 py-3.5 text-center">
                            <span class="text-sm font-semibold text-emerald-600">@tech.ResolvedIncidents</span>
                        </td>
                        <td class="px-5 py-3.5 text-center">
                            <span class="text-sm text-gray-700">@FormatHours(tech.AverageResolutionTimeHours)h</span>
                        </td>
                        <td class="px-5 py-3.5 text-center">
                            <div class="flex items-center justify-center gap-1.5">
                                <div class="w-12 bg-gray-100 rounded-full h-2">
                                    <div class="h-full rounded-full @GetResolutionRateBarClass(tech.ResolutionRate)"
                                         style="width: @tech.ResolutionRate%"></div>
                                </div>
                                <span class="text-xs font-medium @GetResolutionRateClass(tech.ResolutionRate)">
                                    @tech.ResolutionRate.ToString("F0")%
                                </span>
                            </div>
                        </td>
                    </RowTemplate>
                </StatTable>
            </section>
        }
    </div>
</main>

@* Modal de Generación de Reportes *@
<ReportPreviewModal @bind-IsOpen="showReportModal"
                    StartDate="@startDate"
                    EndDate="@endDate"
                    OnGenerateReport="HandleGenerateReport" />

@* Loading Skeleton Component *@
@code {
    private RenderFragment LoadingSkeleton => __builder =>
    {
        <div class="space-y-6 animate-pulse">
            @* KPI Skeletons *@
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-4">
                @for (int i = 0; i < 7; i++)
                {
                    <div class="bg-white rounded-2xl p-5 border border-gray-100">
                        <div class="flex justify-between">
                            <div class="space-y-3 flex-1">
                                <div class="h-3 bg-gray-200 rounded w-20"></div>
                                <div class="h-8 bg-gray-200 rounded w-16"></div>
                            </div>
                            <div class="w-12 h-12 bg-gray-200 rounded-xl"></div>
                        </div>
                    </div>
                }
            </div>
            
            @* Time metrics skeletons *@
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="h-36 bg-gradient-to-br from-gray-200 to-gray-300 rounded-2xl"></div>
                <div class="h-36 bg-gradient-to-br from-gray-200 to-gray-300 rounded-2xl"></div>
            </div>
            
            @* Chart skeletons *@
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                @for (int i = 0; i < 3; i++)
                {
                    <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
                        <div class="px-5 py-4 border-b border-gray-100">
                            <div class="h-4 bg-gray-200 rounded w-32"></div>
                        </div>
                        <div class="p-5 h-64 flex items-center justify-center">
                            <div class="w-32 h-32 bg-gray-200 rounded-full"></div>
                        </div>
                    </div>
                }
            </div>
        </div>
    };
}

@code {
    private DashboardStatisticsDto? statistics;
    private List<TrendDataDto>? trendData;
    private bool isLoading = true;
    private bool isLoadingCharts = false;
    private bool isExporting = false;
    private bool showReportModal = false;
    private DateTime lastUpdated = DateTime.Now;
    
    private DateTime startDate = DateTime.Today.AddDays(-30);
    private DateTime endDate = DateTime.Today;
    private string selectedPeriod = "month";
    private string trendPeriod = "daily";

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && statistics != null && !isLoading)
        {
            await RenderCharts();
        }
    }

    private async Task LoadStatistics()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var query = new GetDashboardStatisticsQuery
            {
                StartDate = startDate,
                EndDate = endDate
            };

            statistics = await Mediator.Send(query);

            // Los datos de tendencia ya vienen en DashboardStatisticsDto
            trendData = trendPeriod == "monthly" ? statistics?.MonthlyTrend : statistics?.DailyTrend;
            
            lastUpdated = DateTime.Now;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading statistics: {ex.Message}");
            statistics = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleFilterApply((DateTime Start, DateTime End) filter)
    {
        startDate = filter.Start;
        endDate = filter.End;
        await LoadStatistics();
    }

    private async Task HandleExport(string format)
    {
        // Abrir el modal de configuración de reportes
        showReportModal = true;
        await Task.CompletedTask;
    }

    private async Task HandleGenerateReport(GenerateReportRequest request)
    {
        isExporting = true;
        StateHasChanged();

        try
        {
            if (request.Format == "pdf")
            {
                // Use JS Interop to download the PDF
                var fileName = $"Dashboard_Report_{request.StartDate:yyyyMMdd}_{request.EndDate:yyyyMMdd}.pdf";
                await JSRuntime.InvokeVoidAsync("downloadPdfReport", 
                    $"{NavigationManager.BaseUri}api/reports/dashboard/pdf", 
                    request, 
                    fileName);
            }
            else if (request.Format == "excel")
            {
                // Use JS Interop to download the Excel
                var fileName = $"Dashboard_Report_{request.StartDate:yyyyMMdd}_{request.EndDate:yyyyMMdd}.xlsx";
                await JSRuntime.InvokeVoidAsync("downloadExcelReport", 
                    $"{NavigationManager.BaseUri}api/reports/dashboard/excel", 
                    request, 
                    fileName);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al exportar: {ex.Message}");
            // TODO: Show toast notification
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private async Task RenderCharts()
    {
        if (statistics == null) return;

        try
        {
            // Status Chart - Doughnut con colores WCAG compliant
            if (statistics.IncidentsByStatus?.Any() == true)
            {
                var statusLabels = statistics.IncidentsByStatus.Select(s => GetStatusDisplay(s.Status)).ToArray();
                var statusData = statistics.IncidentsByStatus.Select(s => s.Count).ToArray();
                var statusColors = new[] { "#3B82F6", "#F59E0B", "#10B981", "#6B7280", "#EF4444" };
                
                await JSRuntime.InvokeVoidAsync("renderDoughnutChart", "statusChart", statusLabels, statusData, statusColors);
            }

            // Priority Chart
            if (statistics.IncidentsByPriority?.Any() == true)
            {
                var priorityLabels = statistics.IncidentsByPriority.Select(p => GetPriorityDisplay(p.Priority)).ToArray();
                var priorityData = statistics.IncidentsByPriority.Select(p => p.Count).ToArray();
                var priorityColors = new[] { "#6B7280", "#3B82F6", "#F59E0B", "#EF4444" };
                
                await JSRuntime.InvokeVoidAsync("renderDoughnutChart", "priorityChart", priorityLabels, priorityData, priorityColors);
            }

            // Type Chart
            if (statistics.IncidentsByType?.Any() == true)
            {
                var typeLabels = statistics.IncidentsByType.Select(t => GetCategoryDisplay(t.Type)).ToArray();
                var typeData = statistics.IncidentsByType.Select(t => t.Count).ToArray();
                var typeColors = new[] { "#8B5CF6", "#EC4899", "#06B6D4", "#84CC16", "#F97316" };
                
                await JSRuntime.InvokeVoidAsync("renderDoughnutChart", "typeChart", typeLabels, typeData, typeColors);
            }

            // Trend Chart - Line
            if (trendData?.Any() == true)
            {
                var trendLabels = trendData.Select(t => t.Date.ToString("dd/MM")).ToArray();
                var createdData = trendData.Select(t => t.Created).ToArray();
                var resolvedData = trendData.Select(t => t.Resolved).ToArray();
                
                await JSRuntime.InvokeVoidAsync("renderLineChart", "trendChart", trendLabels, createdData, resolvedData);
            }

            // Top Services Chart - Bar
            if (statistics.IncidentsByService?.Any() == true)
            {
                var topServices = statistics.IncidentsByService.OrderByDescending(s => s.TotalIncidents).Take(10).ToList();
                var serviceLabels = topServices.Select(s => TruncateString(s.ServiceName, 20)).ToArray();
                var serviceData = topServices.Select(s => s.TotalIncidents).ToArray();
                
                await JSRuntime.InvokeVoidAsync("renderBarChart", "topServicesChart", serviceLabels, serviceData, "#06B6D4");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
        }
    }

    // Helper Methods
    private string FormatHours(double hours)
    {
        if (hours < 1) return $"{(hours * 60):F0}m";
        if (hours < 24) return $"{hours:F1}";
        return $"{(hours / 24):F1}d";
    }

    private string TruncateString(string str, int maxLength)
    {
        if (string.IsNullOrEmpty(str) || str.Length <= maxLength)
            return str;
        return str.Substring(0, maxLength - 3) + "...";
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }

    private string GetStatusDisplay(string status) => status switch
    {
        "Open" => "Abierto",
        "InProgress" => "En Progreso",
        "Resolved" => "Resuelto",
        "Closed" => "Cerrado",
        "Escalated" => "Escalado",
        _ => status
    };

    private string GetPriorityDisplay(string priority) => priority switch
    {
        "Low" => "Baja",
        "Medium" => "Media",
        "High" => "Alta",
        "Critical" => "Crítica",
        _ => priority
    };

    private string GetCategoryDisplay(string category) => category switch
    {
        "Hardware" => "Hardware",
        "Software" => "Software",
        "Network" => "Red",
        "Security" => "Seguridad",
        "Other" => "Otro",
        _ => category
    };

    private string GetStatusColorClass(string status) => status switch
    {
        "Open" => "bg-blue-500",
        "InProgress" => "bg-amber-500",
        "Resolved" => "bg-emerald-500",
        "Closed" => "bg-gray-400",
        "Escalated" => "bg-red-500",
        _ => "bg-gray-400"
    };

    private string GetPriorityColorClass(string priority) => priority switch
    {
        "Low" => "bg-gray-400",
        "Medium" => "bg-blue-500",
        "High" => "bg-amber-500",
        "Critical" => "bg-red-500",
        _ => "bg-gray-400"
    };

    private string GetOpenCountClass(int count) => count switch
    {
        0 => "bg-gray-100 text-gray-600",
        < 5 => "bg-blue-100 text-blue-700",
        < 10 => "bg-amber-100 text-amber-700",
        _ => "bg-red-100 text-red-700"
    };

    private string GetResolutionRateClass(double rate) => rate switch
    {
        >= 80 => "text-emerald-600",
        >= 60 => "text-amber-600",
        _ => "text-red-600"
    };

    private string GetResolutionRateClass(decimal rate) => GetResolutionRateClass((double)rate);

    private string GetResolutionRateBarClass(double rate) => rate switch
    {
        >= 80 => "bg-emerald-500",
        >= 60 => "bg-amber-500",
        _ => "bg-red-500"
    };

    private string GetResolutionRateBarClass(decimal rate) => GetResolutionRateBarClass((double)rate);

    private string GetTrendButtonClass(string period) => period == trendPeriod
        ? "px-3 py-1 text-xs font-medium bg-white text-gray-900 rounded-md shadow-sm"
        : "px-3 py-1 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md";

    private int GetResolutionRateInt()
    {
        if (statistics == null || statistics.TotalIncidents == 0) return 0;
        return (int)Math.Round((double)(statistics.ResolvedIncidents + statistics.ClosedIncidents) / statistics.TotalIncidents * 100);
    }

    private double GetServiceResolutionRate(ServiceStatDto service)
    {
        if (service.TotalIncidents == 0) return 0;
        return (double)service.ResolvedIncidents / service.TotalIncidents * 100;
    }

    private async Task SetTrendPeriod(string period)
    {
        if (trendPeriod != period)
        {
            trendPeriod = period;
            trendData = period == "monthly" ? statistics?.MonthlyTrend : statistics?.DailyTrend;
            StateHasChanged();
            await RenderCharts();
        }
    }
}



